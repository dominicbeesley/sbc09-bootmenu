                      ; This program is intended to be a faster SREC loader that is bootstrapped by the BASIC srec loader
                      ; This program then loads a larger program into memory
                      ; This program relocates itself to 800..DFF and uses 600..6FF as workspace
                      
0E00                                  ORG     $E00
                      
                      
0600                  STRBUF          EQU     $600
FFF1                  OSWORD          EQU     $FFF1
007E                  OSB_ACKESC      EQU     $7E
FFF4                  OSBYTE          EQU     $FFF4
FFE3                  OSASCI          EQU     $FFE3
                      
0001                  CC_C            EQU     $01
                      SEC             MACRO
                                      ORCC    #CC_C
                                      ENDM
                      CLC             MACRO
                                      ANDCC   #~CC_C
                                      ENDM
0800                  RUNLOC          EQU     $800
                      
0E00  308C1B          reloc           leax    enter,PCR
0E03  3384                            leau    ,X
0E05  EFE3                            stu     ,--S
0E07  308D0130                        leax    PROG_END,PCR
0E0B  1F10                            tfr     X,D
0E0D  A3E1                            subd    ,S++            
0E0F  108E0800                        ldy     #RUNLOC
0E13  A6C0            1               lda     ,U+
0E15  A7A0                            sta     ,Y+
0E17  301F                            leax    -1,X
0E19  26F8                            bne     1B
0E1B  7E0800                          jmp     RUNLOC
                      
0E1E                  enter
0E1E  863A                            LDA     #':'
0E20  BDFFE3                          JSR     OSASCI
                              ; Read a line of input to &600
0E23  108E0600                        LDY     #STRBUF
0E27  308D0109                        LEAX    os_blk,PCR
0E2B  10AF84                          STY     0,X
0E2E  C6FF                            LDB     #$FF
0E30  E702                            STB     2,X
0E32  CC207E                          LDD     #$207E
0E35  ED03                            STD     3,X
0E37  8600                            LDA     #0
0E39  BDFFF1                          JSR     OSWORD
0E3C  102500E4                        LBCS    escape
0E40  108C0006                        CMPY    #6
0E44  2560                            BLO     notsrec
0E46  8E0600                          LDX     #STRBUF
0E49                  spc
0E49  A680                            LDA     ,X+
0E4B  8120                            CMPA    #' '
0E4D  23FA                            BLS     spc
0E4F  8153                            CMPA    #'S'
0E51  2653                            BNE     notsrec
0E53  1700A4                          LBSR    gethexnyb
0E56  2553                            BCS     nothex
0E58  810A                            CMPA    #10
0E5A  244A                            BHS     notsrec
0E5C  A78D00D2                        STA     srec_type,PCR
0E60  6F8D00CD                        CLR     ck_acc,PCR
0E64  8D77                            BSR     gethex
0E66  2543                            BCS     nothex
0E68  8103                            CMPA    #3
0E6A  253A                            BLO     notsrec
0E6C  1F89                            TFR     A,B
0E6E  A78D00C1                        STA     srec_len,PCR \record length
0E72  3184                            LEAY    ,X
0E74  10AF8D00C0                      STY     bin_start,PCR
0E79                  rdlp
0E79  8D62                            BSR     gethex
0E7B  252E                            BCS     nothex
0E7D  A7A0                            STA     ,Y+
0E7F  5A                              DECB
0E80  26F7                            BNE     rdlp
0E82  A68D00AB                        LDA     ck_acc,PCR      
0E86  4C                              INCA
0E87  2618                            BNE     badck
0E89  AE8D00AC        LDAsrec_typ     LDX     bin_start,PCR
0E8D  A68D00A1                        LDA     srec_type,PCR
0E91  8101                            CMPA    #1
0E93  2728                            BEQ     writemem
0E95  8109                            CMPA    #9
0E97  273D                            BEQ     exec
0E99  863F                            LDA     #'?'
0E9B  BDFFE3                          JSR     OSASCI
0E9E  16FF7D                          LBRA    enter
                      
                                      
0EA1                  badck
0EA1  308C70                          LEAX    str_badck,PCR
0EA4  2008                            BRA     err
0EA6                  notsrec
0EA6  308C6E                          LEAX    str_notsrec,PCR
0EA9  2003                            BRA     err
0EAB                  nothex
0EAB  308C72                          LEAX    str_nothex,PCR
0EAE                  err
0EAE  8D03                            BSR     printX
0EB0  16FF6B                          LBRA    enter
                      
0EB3                  printX
0EB3  A680                            LDA     ,X+
0EB5  2705                            BEQ     printXex
0EB7  BDFFE3                          JSR     OSASCI
0EBA  20F7                            BRA     printX
0EBC                  printXex
0EBC  39                              RTS
                      
0EBD  8677            writemem                LDA     #'w'
0EBF  BDFFE3                          JSR     OSASCI
0EC2  10AE84                          LDY     ,X              ; address
0EC5  E68C6B                          LDB     srec_len,PCR
0EC8  C003                            SUBB    #3
0ECA  3002                            LEAX    2,X
0ECC                  wmlp
0ECC  A680                            LDA     ,X+
0ECE  A7A0                            STA     ,Y+
0ED0  5A                              DECB
0ED1  26F9                            BNE     wmlp
0ED3  16FF48                          LBRA    enter
0ED6  8665            exec            LDA     #'e'
0ED8  BDFFE3                          JSR     OSASCI
0EDB  6E94                            JMP     [,X]
                      
0EDD  8D1B            gethex          BSR     gethexnyb
0EDF  2518                            BCS     1F
0EE1  49                              ROLA
0EE2  49                              ROLA
0EE3  49                              ROLA
0EE4  49                              ROLA
0EE5  A7E2                            STA     ,-S
0EE7  8D11                            BSR     gethexnyb
0EE9  AAE0                            ORA     ,S+
0EEB  250C                            BCS     1F
0EED  A7E2                            STA     ,-S
0EEF  AB8C3F                          ADDA    ck_acc,PCR
0EF2  A78C3C                          STA     ck_acc,PCR
0EF5  A6E0                            LDA     ,S+
0EF7                                  CLC
0EF7  1CFE                            ANDCC   #~CC_C
0EF9  39              1               RTS
                      
0EFA  A680            gethexnyb       LDA     ,X+
0EFC  8030                            SUBA    #'0'
0EFE  2513                            BCS     1F
0F00  810A                            CMPA    #10
0F02  250D                            BLO     2F
0F04  8007                            SUBA    #7
0F06  810A                            CMPA    #10
0F08  2509                            BCS     1F
0F0A  8110                            CMPA    #16
0F0C  2503                            BLO     2F
0F0E                                  SEC
0F0E  1A01                            ORCC    #CC_C
0F10  39                              RTS
0F11                  2               CLC
0F11  1CFE                            ANDCC   #~CC_C
0F13  39              1               RTS
                      
0F14  434B00          str_badck       FCN     "CK"
0F17  5352454300      str_notsrec     FCN     "SREC"          
0F1C  45736300        str_escape      FCN     "Esc"
0F20  48455800        str_nothex      FCN     "HEX"
                      
0F24                  escape
0F24  308CF5                          LEAX    str_escape,PCR
0F27  8D8A                            BSR     printX
0F29  867E                            LDA     #OSB_ACKESC
0F2B  BDFFF4                          JSR     OSBYTE
0F2E  16FEED                          LBRA    enter
0F31  00              ck_acc          FCB     0
0F32  00              srec_type       FCB     0
0F33  00              srec_len                FCB     0
0F34  0000000000      os_blk          RZB     5
0F39  0000            bin_start       FDB     0
                      
0F3B                  PROG_END
                      
0F3B                                  END     reloc
