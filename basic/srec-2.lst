                      ; This program is intended to be a faster SREC loader that is bootstrapped by the BASIC srec loader
                      ; This program then loads a larger program into memory
                      ; This program relocates itself to 800..DFF and uses 600..6FF as workspace
                      
0E00                                  ORG     $E00
                      
                      
0600                  STRBUF          EQU     $600
FFF1                  OSWORD          EQU     $FFF1
007E                  OSB_ACKESC      EQU     $7E
FFF4                  OSBYTE          EQU     $FFF4
FFE3                  OSASCI          EQU     $FFE3
                      
0001                  CC_C            EQU     $01
                      SEC             MACRO
                                      ORCC    #CC_C
                                      ENDM
                      CLC             MACRO
                                      ANDCC   #~CC_C
                                      ENDM
0800                  RUNLOC          EQU     $800
                      
0E00  308C1D          reloc           leax    enter,PCR
0E03  3384                            leau    ,X
0E05  EFE3                            stu     ,--S
0E07  308D0132                        leax    PROG_END,PCR
0E0B  1F10                            tfr     X,D
0E0D  A3E1                            subd    ,S++    
0E0F  1F01                            tfr     D,X     
0E11  108E0800                        ldy     #RUNLOC
0E15  A6C0            1               lda     ,U+
0E17  A7A0                            sta     ,Y+
0E19  301F                            leax    -1,X
0E1B  26F8                            bne     1B
0E1D  7E0800                          jmp     RUNLOC
                      
0E20                  enter
0E20  863A                            LDA     #':'
0E22  BDFFE3                          JSR     OSASCI
                              ; Read a line of input to &600
0E25  108E0600                        LDY     #STRBUF
0E29  308D0109                        LEAX    os_blk,PCR
0E2D  10AF84                          STY     0,X
0E30  C6FF                            LDB     #$FF
0E32  E702                            STB     2,X
0E34  CC207E                          LDD     #$207E
0E37  ED03                            STD     3,X
0E39  8600                            LDA     #0
0E3B  BDFFF1                          JSR     OSWORD
0E3E  102500E4                        LBCS    escape
0E42  108C0006                        CMPY    #6
0E46  2560                            BLO     notsrec
0E48  8E0600                          LDX     #STRBUF
0E4B                  spc
0E4B  A680                            LDA     ,X+
0E4D  8120                            CMPA    #' '
0E4F  23FA                            BLS     spc
0E51  8153                            CMPA    #'S'
0E53  2653                            BNE     notsrec
0E55  1700A4                          LBSR    gethexnyb
0E58  2553                            BCS     nothex
0E5A  810A                            CMPA    #10
0E5C  244A                            BHS     notsrec
0E5E  A78D00D2                        STA     srec_type,PCR
0E62  6F8D00CD                        CLR     ck_acc,PCR
0E66  8D77                            BSR     gethex
0E68  2543                            BCS     nothex
0E6A  8103                            CMPA    #3
0E6C  253A                            BLO     notsrec
0E6E  1F89                            TFR     A,B
0E70  A78D00C1                        STA     srec_len,PCR    ;record length
0E74  3184                            LEAY    ,X
0E76  10AF8D00C0                      STY     bin_start,PCR
0E7B                  rdlp
0E7B  8D62                            BSR     gethex
0E7D  252E                            BCS     nothex
0E7F  A7A0                            STA     ,Y+
0E81  5A                              DECB
0E82  26F7                            BNE     rdlp
0E84  A68D00AB                        LDA     ck_acc,PCR      
0E88  4C                              INCA
0E89  2618                            BNE     badck
0E8B  AE8D00AC        LDAsrec_typ     LDX     bin_start,PCR
0E8F  A68D00A1                        LDA     srec_type,PCR
0E93  8101                            CMPA    #1
0E95  2728                            BEQ     writemem
0E97  8109                            CMPA    #9
0E99  273D                            BEQ     exec
0E9B  863F                            LDA     #'?'
0E9D  BDFFE3                          JSR     OSASCI
0EA0  16FF7D                          LBRA    enter
                      
                                      
0EA3                  badck
0EA3  308C70                          LEAX    str_badck,PCR
0EA6  2008                            BRA     err
0EA8                  notsrec
0EA8  308C6E                          LEAX    str_notsrec,PCR
0EAB  2003                            BRA     err
0EAD                  nothex
0EAD  308C72                          LEAX    str_nothex,PCR
0EB0                  err
0EB0  8D03                            BSR     printX
0EB2  16FF6B                          LBRA    enter
                      
0EB5                  printX
0EB5  A680                            LDA     ,X+
0EB7  2705                            BEQ     printXex
0EB9  BDFFE3                          JSR     OSASCI
0EBC  20F7                            BRA     printX
0EBE                  printXex
0EBE  39                              RTS
                      
0EBF  8677            writemem                LDA     #'w'
0EC1  BDFFE3                          JSR     OSASCI
0EC4  10AE84                          LDY     ,X              ; address
0EC7  E68C6B                          LDB     srec_len,PCR
0ECA  C003                            SUBB    #3
0ECC  3002                            LEAX    2,X
0ECE                  wmlp
0ECE  A680                            LDA     ,X+
0ED0  A7A0                            STA     ,Y+
0ED2  5A                              DECB
0ED3  26F9                            BNE     wmlp
0ED5  16FF48                          LBRA    enter
0ED8  8665            exec            LDA     #'e'
0EDA  BDFFE3                          JSR     OSASCI
0EDD  6E94                            JMP     [,X]
                      
0EDF  8D1B            gethex          BSR     gethexnyb
0EE1  2518                            BCS     1F
0EE3  49                              ROLA
0EE4  49                              ROLA
0EE5  49                              ROLA
0EE6  49                              ROLA
0EE7  A7E2                            STA     ,-S
0EE9  8D11                            BSR     gethexnyb
0EEB  AAE0                            ORA     ,S+
0EED  250C                            BCS     1F
0EEF  A7E2                            STA     ,-S
0EF1  AB8C3F                          ADDA    ck_acc,PCR
0EF4  A78C3C                          STA     ck_acc,PCR
0EF7  A6E0                            LDA     ,S+
0EF9                                  CLC
0EF9  1CFE                            ANDCC   #~CC_C
0EFB  39              1               RTS
                      
0EFC  A680            gethexnyb       LDA     ,X+
0EFE  8030                            SUBA    #'0'
0F00  2513                            BCS     1F
0F02  810A                            CMPA    #10
0F04  250D                            BLO     2F
0F06  8007                            SUBA    #7
0F08  810A                            CMPA    #10
0F0A  2509                            BCS     1F
0F0C  8110                            CMPA    #16
0F0E  2503                            BLO     2F
0F10                                  SEC
0F10  1A01                            ORCC    #CC_C
0F12  39                              RTS
0F13                  2               CLC
0F13  1CFE                            ANDCC   #~CC_C
0F15  39              1               RTS
                      
0F16  434B00          str_badck       FCN     "CK"
0F19  5352454300      str_notsrec     FCN     "SREC"          
0F1E  45736300        str_escape      FCN     "Esc"
0F22  48455800        str_nothex      FCN     "HEX"
                      
0F26                  escape
0F26  308CF5                          LEAX    str_escape,PCR
0F29  8D8A                            BSR     printX
0F2B  867E                            LDA     #OSB_ACKESC
0F2D  BDFFF4                          JSR     OSBYTE
0F30  16FEED                          LBRA    enter
0F33  00              ck_acc          FCB     0
0F34  00              srec_type       FCB     0
0F35  00              srec_len                FCB     0
0F36  0000000000      os_blk          RZB     5
0F3B  0000            bin_start       FDB     0
                      
0F3D                  PROG_END
                      
0F3D                                  END     reloc
